
substitutions:
  # Device Info
  device_name: "e-ink-frame-downstairs"
  friendly_name: "E-Ink Frame Downstairs"

  # Pin Assignments for XIAO ESP32C6 to Waveshare 7.3" e-Paper HAT (F)
  # Using hardware SPI pins for reliable communication
  # XIAO ESP32C6 pinout: https://wiki.seeedstudio.com/xiao_esp32c6_getting_started/
  # Waveshare HAT connector directly to XIAO expansion board
  pin_clk: "GPIO19"   # D8 - SPI SCK (hardware SPI)
  pin_mosi: "GPIO18"  # D10 - SPI MOSI (hardware SPI)
  pin_cs: "GPIO2"     # D2 - Chip Select
  pin_dc: "GPIO21"    # D3 - Data/Command
  pin_busy: "GPIO23"  # D5 - Busy signal (ACTIVE LOW - must be inverted!)
  pin_reset: "GPIO22" # D4 - Reset

  # Deep Sleep
  gpio_deep_sleep_wake_up: "GPIO4"
  sleep_duration: "30min"

  # Location
  latitude: "53.1935777"
  longitude: "-6.120645"
  timezone: "Europe/Dublin"

  # Display - Waveshare 7.3" e-Paper HAT (G) 4-Color (800x480)
  # Actual display: HAT (G) with Black, White, Red, Yellow
  # Using 7.30in-f driver (no native HAT G support yet)
  # Color mapping applied in color: section to correct for driver differences
  waveshare_model: "7.30in-f"

esphome:
  name: ${device_name}
  friendly_name: ${friendly_name}
  on_boot:
    priority: -100  # Run after everything else is initialized
    then:
      - logger.log: "Boot complete, waiting for display to initialize..."
      - delay: 5s
      - logger.log: "Triggering initial display refresh..."
      - component.update: eink_display

esp32:
  board: seeed_xiao_esp32c6
  framework:
    type: esp-idf

# Enable logging
logger:
  level: DEBUG

# Enable IPv6
network:
  enable_ipv6: true

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

# Enable Home Assistant API
api:
  encryption:
    key: !secret api_encryption_key_e_ink_frame_downstairs

ota:
  - platform: esphome
    password: !secret ota_password_e_ink_frame_downstairs

# SPI Configuration for e-ink display
spi:
  clk_pin: ${pin_clk}
  mosi_pin: ${pin_mosi}
  id: spi_bus

# Time component
time:
  - platform: homeassistant
    id: homeassistant_time
    timezone: ${timezone}

# Sun component for sunrise/sunset
sun:
  latitude: ${latitude}
  longitude: ${longitude}

# Define colors for Waveshare 7.3" e-Paper HAT (G) 4-Color display
# The display supports: Black, White, Red, Yellow
# Using 7.30in-f (7-color) driver with color mapping adjustments:
#   - What the driver calls "green" displays as Yellow on HAT (G)
#   - What the driver calls "blue" displays as Red on HAT (G)
#
# Color mapping for HAT (G):
#   Driver Color  -> HAT (G) Display
#   Black         -> Black
#   White         -> White
#   Green         -> Yellow
#   Blue          -> Red
#
color:
  - id: color_black
    red: 0%
    green: 0%
    blue: 0%
    white: 0%

  - id: color_white
    red: 100%
    green: 100%
    blue: 100%
    white: 100%

  # For HAT (G): Use driver's "green" channel to display YELLOW
  - id: color_yellow
    red: 0%
    green: 100%
    blue: 0%

  # For HAT (G): Use driver's "blue" channel to display RED
  - id: color_red
    red: 0%
    green: 0%
    blue: 100%

# Fonts
font:
  - file: "gfonts://Roboto"
    id: font_small
    size: 20
    
  - file: "gfonts://Roboto"
    id: font_medium
    size: 30
    
  - file: "gfonts://Roboto"
    id: font_large
    size: 60
    
  - file: "gfonts://Roboto@700"
    id: font_bold
    size: 40

# Material Design Icons
  - file: 'https://github.com/Templarian/MaterialDesign-Webfont/raw/master/fonts/materialdesignicons-webfont.ttf'
    id: font_icons
    size: 50
    glyphs:
      - "\U000F0590" # mdi:weather-cloudy
      - "\U000F0591" # mdi:weather-fog
      - "\U000F0592" # mdi:weather-hail
      - "\U000F0593" # mdi:weather-lightning
      - "\U000F067E" # mdi:weather-lightning-rainy
      - "\U000F0594" # mdi:weather-night
      - "\U000F0595" # mdi:weather-partlycloudy
      - "\U000F0596" # mdi:weather-pouring
      - "\U000F0597" # mdi:weather-rainy
      - "\U000F0598" # mdi:weather-snowy
      - "\U000F067F" # mdi:weather-snowy-rainy
      - "\U000F0599" # mdi:weather-sunny
      - "\U000F059D" # mdi:weather-windy
      - "\U000F059E" # mdi:weather-windy-variant

# Text sensors for Home Assistant data
text_sensor:
  - platform: homeassistant
    id: weather_condition
    entity_id: weather.home
    
  - platform: homeassistant
    id: calendar_event
    entity_id: calendar.personal
    attribute: message

# Sensors for Home Assistant data  
sensor:
  - platform: homeassistant
    id: weather_temperature
    entity_id: weather.home
    attribute: temperature
    
  - platform: homeassistant
    id: weather_humidity
    entity_id: weather.home
    attribute: humidity

  # WiFi Signal Sensor
  - platform: wifi_signal
    name: "${friendly_name} WiFi Signal"
    update_interval: 60s

# E-Ink Display
display:
  - platform: waveshare_epaper
    id: eink_display
    cs_pin: ${pin_cs}
    dc_pin: ${pin_dc}
    busy_pin:
      number: ${pin_busy}
      inverted: true  # REQUIRED for 7.30in-f to prevent display damage!
    reset_pin: ${pin_reset}
    model: ${waveshare_model}
    update_interval: never
    rotation: 0Â°
    
    lambda: |-
      // ===========================================
      // E-INK DISPLAY TEST PATTERN
      // Waveshare 7.3" e-Paper HAT (G) 4-Color (800x480)
      // Colors: Black, White, Red, Yellow
      // ===========================================

      // Clear display with white background
      it.fill(id(color_white));

      // Title
      it.printf(400, 20, id(font_bold), id(color_black), TextAlign::TOP_CENTER,
                "E-Ink Display Test");

      it.printf(400, 70, id(font_small), id(color_black), TextAlign::TOP_CENTER,
                "Waveshare 7.3\" HAT (G) - 4 Color");

      // Draw 4 color bars to test all available colors
      // Display is 800x480, divide into 4 vertical bars of 200px each
      int bar_width = 200;
      int bar_height = 200;
      int bar_y = 100;

      // Black bar
      it.filled_rectangle(0, bar_y, bar_width, bar_height, id(color_black));
      it.printf(100, bar_y + bar_height + 10, id(font_medium), id(color_black), TextAlign::TOP_CENTER, "Black");

      // White bar (with black border)
      it.rectangle(bar_width, bar_y, bar_width, bar_height, id(color_black));
      it.printf(bar_width + 100, bar_y + bar_height + 10, id(font_medium), id(color_black), TextAlign::TOP_CENTER, "White");

      // Red bar
      it.filled_rectangle(bar_width * 2, bar_y, bar_width, bar_height, id(color_red));
      it.printf(bar_width * 2 + 100, bar_y + bar_height + 10, id(font_medium), id(color_red), TextAlign::TOP_CENTER, "Red");

      // Yellow bar
      it.filled_rectangle(bar_width * 3, bar_y, bar_width, bar_height, id(color_yellow));
      it.printf(bar_width * 3 + 100, bar_y + bar_height + 10, id(font_medium), id(color_yellow), TextAlign::TOP_CENTER, "Yellow");

      // Display resolution info
      it.printf(400, 380, id(font_medium), id(color_black), TextAlign::TOP_CENTER,
                "Resolution: 800 x 480");

      // Show time if available (confirms Home Assistant connection)
      auto time = id(homeassistant_time).now();
      if (time.is_valid()) {
        it.printf(400, 420, id(font_medium), id(color_red), TextAlign::TOP_CENTER,
                  "Time: %02d:%02d:%02d", time.hour, time.minute, time.second);
        it.printf(400, 460, id(font_small), id(color_yellow), TextAlign::TOP_CENTER,
                  "Home Assistant Connected!");
      } else {
        it.printf(400, 420, id(font_medium), id(color_red), TextAlign::TOP_CENTER,
                  "Waiting for Home Assistant...");
      }

# Deep Sleep Configuration (DISABLED FOR TESTING)
# Uncomment when ready for production use
# deep_sleep:
#   id: deep_sleep_control
#   run_duration: 30s
#   sleep_duration: ${sleep_duration}
#   wakeup_pin: ${gpio_deep_sleep_wake_up}
#   wakeup_pin_mode: KEEP_AWAKE

# Buttons to control display update
button:
  - platform: template
    name: "${friendly_name} Refresh Display"
    icon: "mdi:refresh"
    on_press:
      then:
        - logger.log: "Manual display refresh triggered"
        - component.update: eink_display

  # Deep sleep button disabled during testing
  # - platform: template
  #   name: "${friendly_name} Deep Sleep"
  #   icon: "mdi:sleep"
  #   on_press:
  #     then:
  #       - deep_sleep.enter: deep_sleep_control

  - platform: restart
    name: "${friendly_name} Restart"