name: Deploy Config

on:
  workflow_run:
    workflows:
      - "Home Assistant Configuration Check"
      - "ESPHome Configuration Check"
    types:
      - completed
    branches:
      - main

jobs:
  deploy_config:
    runs-on: ubuntu-latest
    # Only deploy if:
    # 1. The triggering workflow succeeded
    # 2. It was triggered by a push (not a PR)
    # Note: With multiple workflows in the list, this job runs when ANY workflow completes.
    # We check the specific workflow name and conclusion to handle this correctly.
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'push'
    steps:
      - name: Check all required workflows passed
        uses: actions/github-script@v7
        with:
          script: |
            const requiredWorkflows = [
              'Home Assistant Configuration Check',
              'ESPHome Configuration Check'
            ];

            // Get the head SHA from the triggering workflow
            const headSha = context.payload.workflow_run.head_sha;
            console.log(`Checking workflows for commit: ${headSha}`);

            // Get all workflow runs for this commit
            const { data: runs } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head_sha: headSha,
              status: 'completed'
            });

            // Check each required workflow
            for (const workflowName of requiredWorkflows) {
              const workflowRun = runs.workflow_runs.find(
                run => run.name === workflowName && run.conclusion === 'success'
              );

              if (!workflowRun) {
                // Check if workflow was skipped (no matching files changed)
                const skippedRun = runs.workflow_runs.find(
                  run => run.name === workflowName && run.conclusion === 'skipped'
                );

                if (skippedRun) {
                  console.log(`✓ ${workflowName}: skipped (no matching files changed)`);
                  continue;
                }

                // Check if workflow hasn't run yet (might not have matching path filters)
                const anyRun = runs.workflow_runs.find(run => run.name === workflowName);
                if (!anyRun) {
                  console.log(`✓ ${workflowName}: not triggered (no matching files changed)`);
                  continue;
                }

                core.setFailed(`${workflowName} has not succeeded yet. Status: ${anyRun?.conclusion || 'unknown'}`);
                return;
              }

              console.log(`✓ ${workflowName}: passed`);
            }

            console.log('All required workflows have passed!');

      - name: Deploy to Home Assistant
        uses: joelwmale/webhook-action@2.1.0
        with:
          url: ${{ secrets.HOME_ASSISTANT_WEBHOOK_URL }}
          body: '{}'
